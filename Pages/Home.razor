@page "/"
@using GitPagePortfolio.Models
@using GitPagePortfolio.Services
@using System.Text.RegularExpressions
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager
@inject PortfolioService PortfolioService

<style>
/* 애니메이션 정의 (둥둥 떠다니는 효과) */
    @@keyframes floating-wobble
    {
        0% { transform: scale(1.0) rotate(-1deg) translateY(0px); }
        50% { transform: scale(1.02) rotate(1deg) translateY(-5px); }
        100% { transform: scale(1.0) rotate(-1deg) translateY(0px); }
    }

    /* 깃허브 버튼 스타일 */
    .github-button
    {
        transition: all 0.3s ease-in-out;
    }

    .github-button:hover
    {
        box-shadow: 0 0 50px rgba(57, 255, 20, 0.5);
        background-color: rgba(57, 255, 20, 0.25);
        animation: floating-wobble 3s ease-in-out infinite alternate;
    }

    /* 화살표 링크 호버 효과 */
    .hover-scale
    {
        transition: transform 0.2s;
    }

    .hover-scale:hover
    {
        transform: scale(1.1); /* 마우스 올리면 1.1배 커짐 */
    }
</style>

<PageTitle>ReltyWorks - Home</PageTitle>

@* --- [상단 자기소개 영역] --- *@
<MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="2" Class="my-16">
    <MudText Typo="Typo.h2" Color="Color.Primary" Style="font-weight:bold; text-shadow: 0 0 20px #39ff14;">
        ReltyWorks
    </MudText>
    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4">
        UNITY & C# DEVELOPER
    </MudText>
    <MudText Typo="Typo.body1" Align="Align.Center">
        안녕하세요!<br />
        저는 <b>Unity</b>와 <b>C#</b>개발자입니다.<br />
        <br />
        <b>일관성 있는 코딩 컨벤션</b>과 <b>객체지향 원칙</b>을 준수하며,<br />
        타인이 읽기 쉽고 재사용 가능한 코드를 작성하는 것을 지향합니다.<br />
        그리고, 새로운 기술을 배우고 적용하는 과정을 즐깁니다.<br />
        <br />
        보고 계신 이 웹사이트 또한<br />
        <b>Blazor WebAssembly</b>와 <b>MudBlazor</b>를 학습하여 직접 제작하였으며,<br />
        <b>GitHub Pages</b>를 통해 배포되고 있습니다.
    </MudText>
</MudStack>

<MudDivider Class="my-12" />

@* --- [KEY PORTFOLIO 영역] --- *@
<MudText Typo="Typo.h4" Color="Color.Primary" Align="Align.Center" Class="mb-8" Style="text-shadow: 0 0 10px #39ff14;">
    [ KEY PORTFOLIO ]
</MudText>

@if (_parsedSections != null && _parsedSections.Count > 0)
{
    <MudContainer MaxWidth="MaxWidth.Large">

        <MudPaper Outlined="true" Class="pa-4 mb-8" Style="border: 2px solid #39ff14; background-color: rgba(57, 255, 20, 0.05);">
            <MudStack Spacing="4">

                @foreach (var section in _parsedSections)
                {
                    <div class="mb-4">
                        @* 1. 섹션 타이틀 및 링크 *@
                        <div class="d-flex align-center mb-2 mt-4">
                            <MudText Typo="Typo.h5" Color="Color.Primary" Style="font-weight:bold;">
                                @section.DisplayTitle
                            </MudText>

                            @* TargetId가 유효할 때만 화살표 표시 *@
                            @if (section.TargetId >= 0)
                            {
                                <MudLink Href="@($"/portfolio/{section.TargetId}")" Underline="Underline.None" Class="ml-2 hover-scale">
                                    <MudText Typo="Typo.h5" Color="Color.Primary" Style="cursor:pointer;"> ▷▷▷</MudText>
                                </MudLink>
                            }
                        </div>

                        @* 2. 해당 섹션의 이미지들 뿌리기 *@
                        @for (int i = 0; i < section.ImgCount; i++)
                        {
                            // 전체 인덱스는 startIdx + i
                            // 파일명은 1부터 시작하므로 +1
                            int fileNum = section.StartImgIdx + i + 1;
                            string imgPath = $"files/00/{fileNum:D2}.jpg";

                            <MudImage Src="@imgPath" Fluid="true" Class="rounded-lg mb-2" Style="width: 100%; display: block;" />
                        }
                    </div>
                }

            </MudStack>
        </MudPaper>

        <div class="d-flex justify-center my-4">
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Large" Href="/portfolios">
                &gt; 전체 프로젝트 목록 보기
            </MudButton>
        </div>
    </MudContainer>
}

<MudDivider Class="my-12" />

@* --- [하단 링크 영역] --- *@
<MudGrid Class="mb-16">
    <MudItem xs="12" md="6">
        <MudText Typo="Typo.h4" Color="Color.Primary" Align="Align.Center" Class="mb-4">[ GITHUB ]</MudText>
        <MudPaper Class="d-flex flex-column align-center justify-center py-8 github-button"
                  Outlined="true"
                  Style="border-color:#39ff14; cursor:pointer;"
                  @onclick="@(() => NavigateToGithub())">
            <MudIcon Icon="@Icons.Custom.Brands.GitHub" Size="Size.Large" Color="Color.Primary" Style="font-size: 5rem;" />
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mt-4">VISIT MY GITHUB</MudText>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudText Typo="Typo.h4" Color="Color.Primary" Align="Align.Center" Class="mb-4">[ CONTACT ]</MudText>
        <MudList T="string" Clickable="true">
            <MudListItem Icon="@Icons.Material.Filled.Email" IconColor="Color.Primary" OnClick="@(() => CopyToClipboard("relty.works@gmail.com"))">
                relty.works@gmail.com
            </MudListItem>
            <MudListItem Icon="@Icons.Custom.Brands.Discord" IconColor="Color.Primary" OnClick="@(() => CopyToClipboard("https://discord.gg/zUjWwqYuz2"))">
                Discord Community
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.LocationOn" IconColor="Color.Primary">
                Seoul, Republic of Korea
            </MudListItem>
        </MudList>
    </MudItem>
</MudGrid>

@code {
    private class SectionInfo
    {
        public string DisplayTitle { get; set; } = "";
        public int TargetId { get; set; } = -1;
        public int StartImgIdx { get; set; }
        public int ImgCount { get; set; }
    }

    private List<SectionInfo> _parsedSections = new();

    protected override void OnInitialized()
    {
        // 0번(KeyPortfolio) 데이터 가져오기
        var keyPortfolio = PortfolioService.GetById(0);

        if (keyPortfolio != null && !string.IsNullOrWhiteSpace(keyPortfolio.Description))
        {
            ParseDescription(keyPortfolio.Description);
        }
    }

    // 정규표현식을 사용하여 jpgCount와 pofolLink를 정확하게 추출
    private void ParseDescription(string rawDescription)
    {
        var lines = rawDescription.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
        int currentImgIndex = 0;

        // 패턴: jpgCount(숫자) + pofolLink(숫자)
        // 예: jpgCount3pofolLink2 -> Group[1]: 3, Group[2]: 2
        var regex = new Regex(@"jpgCount(\d+)pofolLink(\d+)", RegexOptions.IgnoreCase);

        for (int i = 0; i < lines.Length; i++)
        {
            string line = lines[i].Trim();
            var match = regex.Match(line);

            if (match.Success)
            {
                // 정규표현식으로 숫자 추출
                int count = int.Parse(match.Groups[1].Value); // 이미지 장수
                int linkId = int.Parse(match.Groups[2].Value); // 연결할 포폴 ID

                string title = (i > 0) ? lines[i - 1].Trim() : "Untitled Section";

                _parsedSections.Add(new SectionInfo
                {
                    DisplayTitle = title,
                    TargetId = linkId, // 추출한 ID를 그대로 사용
                    StartImgIdx = currentImgIndex,
                    ImgCount = count
                });

                currentImgIndex += count;
            }
        }
    }

    private async Task CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomCenter;
        Snackbar.Configuration.ShowCloseIcon = false;
        Snackbar.Add($"Copied to clipboard!", Severity.Success, config =>
        {
            config.HideTransitionDuration = 200;
            config.ShowTransitionDuration = 200;
            config.VisibleStateDuration = 750;
        });
    }

    void NavigateToGithub()
    {
        NavManager.NavigateTo("https://github.com/ReltyWorks", true);
    }
}